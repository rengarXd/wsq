<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>body</title>
		<link rel="stylesheet" type="text/css" href="../../css/Hui.css" />
		<link rel="stylesheet" href="../../css/style.css" />
		<link rel="stylesheet" href="../../css/fonts/iconfont.css" />
		<style>
			html, body {
				background-image: url(../../image/main2.png);
				background-size: cover;
				background-position: top;
				background-repeat: no-repeat;
			}
			.lishishangbao {
				background-color: #ff6738;
			}
			.wentishangbao {
				background-color: #ffa03a;
			}
			.wodekaoqin {
				background-color: #93d939;
			}
			.wodegongzuo {
				background-color: #01ceff;
			}
			.wodegongzuo {
				background-color: #01ceff;
			}
			.gerenxinxi {
				background-color: #ea7cff;
			}
			.xiugaimima {
				background-color: #7bcce7;
			}
			.touxiang {
				background: -webkit-gradient(linear, left top, left bottom, from(#10a0d2), to(#7dcced));
				padding: 20px;
				z-index: 1000;
			}
		</style>
	</head>
	<body>
		<div class="touxiang  H-flexbox-horizontal H-box-sizing-border-box  H-clear-both H-padding-horizontal-both-10 H-padding-vertical-both-8">
			<div tapmode="" style="width:60px;height:60px;"><img onerror="javascript:this.src='../../image/noavatar.gif'" src="../../image/noavatar.gif" id="nopic" class="H-width-100-percent H-height-100-percent H-display-block H-border-radius-circle H-border-both">
			</div>
			<div class="H-flex-item H-flexbox-horizontal H-padding-horizontal-left-20 H-vertical-middle H-overflow-hidden">
				<div class="H-width-100-percent H-flex-item">
					<strong id="user_name" class="H-theme-font-color-white  H-font-weight-normal H-display-block H-font-weight-500 H-font-size-16 H-text-show-row-1">暂无信息</strong>
					<strong id="dept_name" class="H-theme-font-color-white  H-font-weight-normal H-display-block H-font-weight-500 H-font-size-13 H-text-show-row-1">暂无信息</strong>
				</div>
				<div id="headguanli" class="">
					<strong class="H-theme-font-color-white  H-font-weight-normal H-display-block H-font-weight-500 H-font-size-12 H-text-show-row-1">GPS卡号：</strong>
					<strong id="gps_code" class="H-theme-font-color-white  H-font-weight-normal H-display-block H-font-weight-500 H-font-size-15 H-text-show-row-1">暂无信息</strong>
				</div>
			</div>
		</div>
		<div id="guanlibaojie">
			<div class="H-flexbox-horizontal H-text-align-center  H-padding-vertical-both-25">
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('history_report_head','./history/history_report_head.html');" class="H-icon H-center-all lishishangbao H-border-radius-9 H-margin-horizontal-auto" style="height: 56px; width: 56px; "><i class="iconfont icon-gongwenbaoxian H-font-size-24 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">历史上报</label>
				</div>
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('question_report_head','./question/question_report_head.html');" class="H-icon H-center-all wentishangbao H-border-radius-9 H-margin-horizontal-auto" style="height: 56px; width: 56px; "><i class="iconfont icon-shangchuanyunduan H-font-size-30 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">问题上报</label>
				</div>
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('history_head','./daily/history_head.html');" class="H-icon H-center-all wodekaoqin H-border-radius-9 H-margin-horizontal-auto" style="height: 56px; width: 56px; "><i class="iconfont icon-dingwei H-font-size-24 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">我的考勤</label>
				</div>
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('msg_head','./work/msg_head.html');" class="H-icon H-center-all wodegongzuo H-border-radius-9 H-margin-horizontal-auto" style="height: 56px; width: 56px; "><i class="iconfont icon-gongzuo H-font-size-26 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">我的工作</label>
				</div>
			</div>
			<div class="H-flexbox-horizontal H-text-align-center  H-padding-vertical-both-20">
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('userinfo_head','../me/userinfo_head.html');" class="H-icon H-center-all gerenxinxi H-border-radius-9 H-margin-horizontal-auto" style="height: 56px; width: 56px; "><i class="iconfont icon-gerenxinxi1 H-font-size-24 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">个人信息</label>
				</div>
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('change_password_head','./password/change_password_head.html');" class="H-icon H-center-all xiugaimima H-border-radius-9 H-margin-horizontal-auto" style="height: 56px; width: 56px; "><i class="iconfont icon-mima H-font-size-22 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">修改密码</label>
				</div>
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('msg_head','../message/help_center_head.html');" class="H-icon H-center-all H-theme-background-color-333 H-border-radius-9 H-margin-horizontal-auto" style="height: 56px; width: 56px; "><i class="iconfont icon-dingdan H-font-size-22 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">公用设施情况</label>
				</div>
				<div class="H-flex-item" style=""></div>
			</div>
		</div>
		<div id="cheliangshimin">
			<div class="H-flexbox-horizontal H-text-align-center  H-padding-vertical-both-25">
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('history_report_head','./history/history_report_head.html');" class="H-icon H-center-all lishishangbao H-border-radius-9 H-margin-horizontal-auto" style="height: 55px; width: 55px; "><i class="iconfont icon-gongwenbaoxian H-font-size-24 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">历史上报</label>
				</div>
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('question_report_head','./question/question_report_head.html');" class="H-icon H-center-all wentishangbao H-border-radius-9 H-margin-horizontal-auto" style="height: 55px; width: 55px; "><i class="iconfont icon-shangchuanyunduan H-font-size-30 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">问题上报</label>
				</div>
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('change_password_head','./password/change_password_head.html');" class="H-icon H-center-all H-theme-background-color1 H-border-radius-9 H-margin-horizontal-auto" style="height: 55px; width: 55px; "><i class="iconfont icon-mima H-font-size-22 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">修改密码</label>
				</div>
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('userinfo_head','../me/userinfo_head.html');" class="H-icon H-center-all gerenxinxi H-border-radius-9 H-margin-horizontal-auto" style="height: 55px; width: 55px; "><i class="iconfont icon-gerenxinxi1 H-font-size-24 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">个人信息</label>
				</div>
			</div>
			<div class="H-flexbox-horizontal H-text-align-center  H-padding-vertical-both-20">
				<div class="H-flex-item">
					<span tapmode onclick="openWinn('msg_head','../message/help_center_head.html');" class="H-icon H-center-all H-theme-background-color-333 H-border-radius-9 H-margin-horizontal-auto" style="height: 56px; width: 56px; "><i class="iconfont icon-dingdan H-font-size-22 H-theme-font-color-white"></i></span>
					<label class="H-display-block H-font-size-13 H-margin-vertical-top-5">公用设施情况</label>
				</div>
				<div class="H-flex-item" style=""></div>
				<div class="H-flex-item" style=""></div>
				<div class="H-flex-item" style=""></div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../script/wsq.js"></script>
	<script type="text/javascript" src="../../script/zepto.min.js"></script>
	<script type="text/javascript">
		var bMap = null, serviceModule = null, infos = null, user = null, retdata = null, cycle = null;
		apiready = function() {
			api.parseTapmode();
			person_type = api.pageParam.person_type;
			//console.log(person_type);
			switch(parseInt(person_type)) {
				case 1:
					$("#cheliangshimin").remove();
					init();
					break;
				case 2:
					$("#cheliangshimin").remove();
					init();
					break;
				case 3:
					$("#guanlibaojie").remove();
					$("#headguanli").remove();
					initshimin();
					break;
				case 9:
					$("#guanlibaojie").remove();
					init();
					break;
			};
			intjpush();
		};
		function init() {
			if (api.systemType == "ios") {
				//初始化模块
				initModel();
				//初始化主程序
				initinfo();
			} else {
				api.getPrefs({
					key : 'userinfo'
				}, function(ret, err) {
					if (ret && ret.value) {
						user = eval('(' + ret.value + ')');
						//console.log(JSON.stringify(user));
						userinfoshow();
						openMap();
					} else {
					}
				});
			}
		}

		//打开地图
		function openMap() {
			var mySettingInfo = api.require('mySettingInfo');
			var bMap = api.require('bMap');
			//获取定位是否开启，及当前 app 获取的定位权限
			bMap.getLocationServices(function(ret, err) {
				//              console.log(JSON.stringify(ret));
				if (ret.enable) {
					if ('ios' == api.systemType) {
						switch(ret.authorizationStatus) {
							case "denied":
								api.confirm({
									title : '温馨提示',
									msg : '检测到您的GPS功能未开启或对本应用设置了禁用GPS，点击确定去开启以提高位置的准确性',
									buttons : ['确定', '取消']
								}, function(ret, err) {
									var index = ret.buttonIndex;
									switch(index) {
										case 1:
											//ios中未开启GPS
											api.openApp({
												iosUrl : 'app-settings:',
												androidPkg : ''
											}, function(ret, err) {
												//coding...
											});
											break;
									}
								});
								break;
						}
					}
					//                    console.log(JSON.stringify(ret));
				} else {
					api.confirm({
						title : '温馨提示',
						msg : '检测到您的GPS功能未开启或对本应用设置了禁用GPS，点击确定去开启以提高位置的准确性',
						buttons : ['确定', '取消']
					}, function(ret, err) {
						var index = ret.buttonIndex;
						switch(index) {
							case 1:
								var mySettingInfo = api.require('mySettingInfo');
								mySettingInfo.settingInt({
									'index' : 2
								}, function(ret, err) {
									alert(JSON.stringify(ret));
								});
								break;
						}
					});
				}
			});
			service();
		}

		function service() {
			serviceModule = api.require('serviceModule');
			serviceModule.initLocation({
				"url" : "http://110.19.111.2:8072/wshuanwei/fileAction.do?eventcode=report_location&funid=gps_wzsb&pagetype=grid&nousercheck=1&",
				"uid" : user[0].user_id,
				"token" : user[0].uuid
			});
			api.getPrefs({
				sync : false,
				key : 'serviceModule'
			}, function(ret, err) {
				if (ret && ret.value) {
					serviceModule.startLocation();
					api.removePrefs({
						key : 'serviceModule'
					});
				}
			});
		}

		//初始化极光推送
		function intjpush() {
			jpush = api.require('ajpush');
			jpush.init(function(ret) {
				//				jpush.setListener(function(ret) {
				//					alert(JSON.stringify(ret));
				//					var id = ret.id;
				//					var title = ret.title;
				//					var content = ret.content;
				//					var extra = ret.extra;
				//				});
			});
			api.addEventListener({
				name : 'appintent'
			}, function(ret, err) {
				if (ret && ret.appParam.ajpush) {
					var ajpush = ret.appParam.ajpush;
					var jsonStr = JSON.parse(ajpush.extra);
					if (jsonStr.problem_id == "1") {
						api.openWin({
							name : 'msg_head',
							url : './work/msg_head.html',
							bounces : false,
							vScrollBarEnabled : false
						});
					} else if(jsonStr.problem_id == "2") {
						api.openWin({
							name : 'history_report_head',
							url : './history/history_report_head.html',
							bounces : false,
							vScrollBarEnabled : false
						});
					}
				}
			});
		}

		//初始化市民
		function initshimin() {
			api.getPrefs({
				key : 'userinfo'
			}, function(ret, err) {
				if (ret && ret.value) {
					user = eval('(' + ret.value + ')');
					console.log(JSON.stringify(user));
					userinfoshow();
				} else {
				}
			});
		}

		//查询用户信息
		function userinfoshow() {
			api.showProgress();
			$xy.ajax(function(ret, err) {
				api.hideProgress();
				if (ret && ret.success) {
					//头像
					$("#nopic").attr('src', window.iconUrl + ret.data[0].attach_path);
					if (parseInt(person_type) == 3) {
						if (ret.data[0].dept_name != "")
							//部门
							document.getElementById('dept_name').innerHTML = ret.data[0].dept_name;
						if (ret.data[0].user_name != "")
							//姓名
							document.getElementById('user_name').innerHTML = ret.data[0].user_name;
					} else {
						if (ret.data[0].gps_code != "")
							//GPS卡号
							document.getElementById('gps_code').innerHTML = ret.data[0].gps_code;
						if (ret.data[0].dept_name != "")
							//部门
							document.getElementById('dept_name').innerHTML = ret.data[0].dept_name;
						if (ret.data[0].user_name != "")
							//姓名
							document.getElementById('user_name').innerHTML = ret.data[0].user_name;
					}
					console.log(JSON.stringify(ret));
				} else if (ret && !ret.success) {
					api.toast({
						msg : ret.message
					});
				} else {
					api.toast({
						msg : err.body
					});
				}
			}, 'appuserinfo&funid=sys_user&user_id=' + user[0].user_id + '&uuid=' + user[0].uuid);
		}

		function openWinn(name, url) {
			$xy.openWin(name, url, false, api.pageParam);
		}

		//重新加载当前页
		function reload() {
			//bMap.close();
			window.location.reload();
		}

		//2.初始化模块
		function initModel() {
			bMap = api.require('bMap');
			//			api.setKeepScreenOn({
			//				keepOn : true
			//			});
			//应用返回前台
			api.addEventListener({
				name : 'resume'
			}, function(ret, err) {
				//alert('应用回到后台');
				reload();
			});
			api.addEventListener({
				name : 'online'
			}, function(ret, err) {
				//alert('已连接到网络');
				reload();
			});
			api.addEventListener({
				name : 'offline'
			}, function(ret, err) {
				//alert('断网了');
				cleanCycle();
			});
		}

		//初始化主程序
		function initinfo() {
			api.getPrefs({
				key : 'userinfo'
			}, function(ret, err) {
				if (ret && ret.value) {
					user = eval('(' + ret.value + ')');
					userinfoshow();
					_workAjax(function() {
						$xy.ajax(function(ret, err) {
							//api.hideProgress();
							if (ret.success) {
								//console.log(JSON.stringify(ret.data[0].locale_coordinate));
								//console.log(JSON.stringify(retdata));
								locale_coordinatedata = ret.data[0].locale_coordinate;
								//绘制多边形
								//addPoly(locale_coordinatedata);
								//判断当前点是否在多边形的范围内
								isPoint(locale_coordinatedata);
								//设置定时上报
								if (!cycle) {
									var arr = [];
									for (var i = 0, l = locale_coordinatedata.length; i < l; i++) {
										arr.push(JSON.stringify(locale_coordinatedata[i]));
									}
									//转换Json格式
									var point = '[' + arr + ']';
									cycle = setInterval('isPoint(' + point + ')', 10 * 1000);
								}
							} else if (ret) {
								api.toast({
									msg : ret.message
								});
							} else {
								api.toast({
									msg : err.body
								});
							}
						}, 'AppUserRegion&funid=hw_locale1&user_id=' + user[0].user_id + '&uuid=' + user[0].uuid);
					});
					//console.log(JSON.stringify(retdata));
				} else {
				}
			});
		}

		//终止考勤
		function cleanCycle() {
			api.toast({
				msg : '终止考勤'
			});
			//			api.sendEvent({
			//				name : 'delet_datas'
			//			});
			clearInterval(cycle);
			cycle = null;
		}

		//判断当前点是否在多边形的范围内方法
		function isPoint(locale_coordinate) {
			//console.log(JSON.stringify(locale_coordinate));
			//$xy.isString(locale_coordinate) ? points = JSON.parse(locale_coordinate) : points = locale_coordinate;
			//百度模块：定位
			bMap.getLocation({
				accuracy : '10m',
				autoStop : true
			}, function(ret, err) {
				if (ret.status) {
					//console.log(JSON.stringify(points));
					var lonn = ret.lon;
					var latt = ret.lat;
					var stamp = ret.timestamp;
					var rett = ret;
					//百度模块：是否在多边形的范围内方法
					bMap.isPolygonContantsPoint({
						point : {
							lon : lonn,
							lat : latt
						},
						points : locale_coordinate
					}, function(ret) {
						//考勤方法
						//outmap(rett, ret);
						//定时上报
						upwork(lonn, latt, stamp, ret.status);
					});
				} else {
					alert(err.code);
				}
			});
		}

		//定时上报
		function upwork(lon, lat, timestamp, status) {
			//status ? status = 1 : status = 0;
			$xy.ajax(function(ret, err) {
				//api.hideProgress();
				if (ret.success) {
					//console.log(JSON.stringify(ret));
					//					api.toast({
					//						msg : ret.message
					//					});
				} else {
					api.toast({
						msg : err.body
					});
					cleanCycle();
				}
			}, 'report_location&funid=gps_wzsb&user_id=' + user[0].user_id + '&uuid=' + user[0].uuid + '&wzsb_lng=' + lon + '&wzsb_lat=' + lat);
		}

		//添加多边形
		function addPoly(locale_coordinate) {
			bMap.addPolygon({
				id : 1,
				styles : {
					borderColor : '#FF0000',
					borderWidth : 2,
					fillColor : '#0000ff'
				},
				points : locale_coordinate
			});
		}

		//考勤方法
		function outmap(ret, status) {
			var nowtime = ret.timestamp;
			//var nowstatus = status;
			for (var i = 0, l = retdata.length; i < l; i++) {
				var intime = retdata[i].in_time;
				var outtime = retdata[i].out_time;
				if ((parseInt(outtime) * 1000 > parseInt(nowtime)) && (parseInt(nowtime)) > (parseInt(intime) * 1000)) {
					//alert(format1000(intime) +format1000(outtime)+ JSON.stringify(retdata[i]));
					//					api.sendEvent({
					//						name : 'datas',
					//						extra : {
					//							class_name : retdata[i].class_name,
					//							timestamp : ret.timestamp,
					//							status : status.status,
					//							intime : 1,
					//							uid : user[0].uuid
					//						}
					//					});
					if (status.status) {
						api.toast({
							msg : '进入考勤范围，在岗'
						});
					} else {
						api.toast({
							msg : "脱离考勤范围，脱岗，下班时间：" + format1000(outtime)
						});
					}
					return;
				} else {
					api.toast({
						msg : "非上班时间"
					});
				}
			}
		}

		//获取班组
		function _workAjax(callback) {
			$xy.ajax(function(ret, err) {
				//api.hideProgress();
				if (ret.success) {
					retdata = ret.data;
					callback();
				}
			}, 'AppUserScheduling&funid=hw_automa&user_id=' + user[0].user_id + '&uuid=' + user[0].uuid);
		}

		//js时间戳转换*1000
		function format1000(shijianchuo) {
			//shijianchuo是整数，否则要parseInt转换
			var time = new Date(parseInt(shijianchuo) * 1000);
			var y = time.getFullYear();
			var m = time.getMonth() + 1;
			var d = time.getDate();
			var h = time.getHours();
			var mm = time.getMinutes();
			var s = time.getSeconds();
			return y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s);
			//alert(y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s));
		}

		//月份处理
		function add0(m) {
			return m < 10 ? '0' + m : m
		}

		//js时间戳转换
		function format(shijianchuo) {
			//shijianchuo是整数，否则要parseInt转换
			var time = new Date(parseInt(shijianchuo));
			var y = time.getFullYear();
			var m = time.getMonth() + 1;
			var d = time.getDate();
			var h = time.getHours();
			var mm = time.getMinutes();
			var s = time.getSeconds();
			return y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s);
			//alert(y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s));
		}

		function worktime(hours) {
			//shijianchuo是整数，否则要parseInt转换
			var time = new Date();
			var y = time.getFullYear();
			var m = time.getMonth() + 1;
			var d = time.getDate();
			return y + '-' + add0(m) + '-' + add0(d) + ' ' + hours;
			//alert(y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s));
		}
	</script>
</html>