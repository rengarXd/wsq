<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>历史上报</title>
		<link rel="stylesheet" type="text/css" href="../../../css/Hui.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../../../css/fonts/iconfont.css" />
	</head>
	<body>
		<div id="history_html">
			<div class="H-position-absolute H-position-center-all" id="statuss">
				<div class="H-font-size-14 H-text-align-center">
					<i class="iconfont icon-dingwei H-font-size-32 H-theme-font-color-999"></i>
					<div class="H-theme-font-color-999">
						加载中
					</div>
				</div>
			</div>
			<!--<div class="H-padding-horizontal-both-10 H-padding-vertical-both-5" >
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class="H-theme-font-color-999">事件类型：</span><span>街道保洁</span>
			</div>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class="H-theme-font-color-999">上报科室：</span><span>办公室</span>
			</div>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class=" H-theme-font-color-999 H-display-inline">上报地址：</span><span>河南省国家大学科技园东区18号楼河</span>
			</div>
			</div>
			<div class="H-flexbox-vertical H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河
			<p class="H-font-size-12 H-theme-font-color-999">
			2017年1月17日9:40:22
			</p>
			</div>
			</div>
			</div>
			<div class="H-padding-horizontal-both-10 H-padding-vertical-both-5">
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class="H-theme-font-color-999">事件类型：</span><span>街道保洁</span>
			</div>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class="H-theme-font-color-999">上报科室：</span><span>办公室</span>
			</div>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class=" H-theme-font-color-999 H-display-inline">上报地址：</span><span>河南省国家大学科技园东区18号楼河</span>
			</div>
			</div>
			<div class="H-flexbox-vertical H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河河南省国家大学科技园东区18号楼河
			<p class="H-font-size-12 H-theme-font-color-999">
			2017年1月17日9:40:22
			</p>
			</div>
			</div>
			</div>-->
		</div>
		<script type="text/html" id="history_data">
			{{# for(var i=0,len=d.length;i<len;i++) { }}
			<div class="H-padding-horizontal-both-10 H-padding-vertical-both-5">
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class="H-theme-font-color-999">事件类型：</span>{{ d[i].problem_type }}
			</div>
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class="H-theme-font-color-999">上报科室：</span>{{ d[i].dept_name }}
			</div>
			</div>
			<div class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class=" H-theme-font-color-999 H-display-inline">上报地址：</span><span id="address">{{ getAddress('d[i].problem_lng', 'd[i].problem_lat') }}</span>
			</div>
			</div>
			<div tapmode="H-touch-active" onclick="job();" class="H-text-list H-flexbox-horizontal  H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class=" H-theme-font-color-999 H-display-inline">人员分配：</span><span id="job"></span>
			</div>
			<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
			</div>
			<div class="H-flexbox-vertical H-theme-background-color-white H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-flex-item H-padding-horizontal-both-10 H-font-size-15 H-padding-vertical-both-12">
			<span class="H-theme-font-color-999">事件描述：</span>{{ d[i].problem_text }}
			<p class="H-font-size-12 H-theme-font-color-999">
			{{ d[i].add_date }}
			</p>
			</div>
			</div>
			</div>
			{{# } }}
		</script>
		<script type="text/javascript" src="../../../script/wsq.js"></script>
		<script type="text/javascript" src="../../../script/tools/laytpl.js"></script>
		<script type="text/javascript" src="../../../script/zepto.min.js"></script>
		<script type="text/javascript">
			var bMap = null, retdata = null;
			apiready = function() {
				initPage();
				listener();
			};
			// 初始化页面
			function initPage() {
				bMap = api.require('bMap');
				//设置下拉刷新
				$xy.setRefreshHeaderInfo(function() {
					location.reload();
				});
				api.getPrefs({
					sync : false,
					key : 'userinfo'
				}, function(ret, err) {
					user = eval('(' + ret.value + ')');
					$xy.ajax(function(ret, err) {
						api.refreshHeaderLoadDone();
						if (ret && ret.success) {
							//console.log(JSON.stringify(ret));
							if (ret.data.length == 0) {
								//当没有订单时的处理
								var htmls = '<div class="H-position-absolute H-position-center-all" id="statuss"><div class="H-font-size-14 H-text-align-center"><i class="iconfont icon-dingwei H-font-size-32 H-theme-font-color-999"></i><div class="H-theme-font-color-999">暂无记录</div></div></div>';
								document.getElementById('history_html').innerHTML = htmls;
							} else {
								console.log(JSON.stringify(ret));
								retdata = ret.data;
								var tpl = document.getElementById('history_data').innerHTML;
								//读取模版
								//方式一：异步渲染（推荐）
								laytpl(tpl).render(retdata, function(render) {
									document.getElementById('history_html').innerHTML = render;
//									getAddress(retdata[0].problem_lng, retdata[0].problem_lat);
								});
							}
						} else {
							var htmls = '<div class="H-position-absolute H-position-center-all" id="statuss"><div class="H-font-size-14 H-text-align-center"><i class="iconfont icon-dingwei H-font-size-32 H-theme-font-color-999"></i><div class="H-theme-font-color-999">' + ret.message + '</div></div></div>';
							document.getElementById('history_html').innerHTML = htmls;
						}
					}, 'selProblem&funid=report_problem&user_id=' + user[0].user_id + '&uuid=' + user[0].uuid + '&type=' + 1);
				});
			}

			//由经纬度获取地址信息
			function getAddress(lon, lat) {
				bMap.getNameFromCoords({
					lon : lon,
					lat : lat
				}, function(ret, err) {
					//              console.log("当前位置信息===" + JSON.stringify(ret));
					if (ret.status) {
						//获取当前用户所属城市
						//console.log("当前位置信息===" + JSON.stringify(ret));
						//ret.province + ret.city + ret.district + ret.streetName + ret.streetNumber +
						return ret.address;
					} else {
						api.toast({
							msg : '连接错误，请检查网络或者请求配置是否正确'
						});
					}
				});
			}

			//人员分配
			function job() {
				$xy.openWin('region_header', 'region_header.html', true, api.pageParam);
			}

			function listener() {
				api.addEventListener({
					name : 'region'
				}, function(ret, err) {
					upjober(ret.value.send_user, ret.value.send_userid);
				});
			}

			function upjober(send_user, sendid) {
				$xy.ajax(function(ret, err) {
					//api.hideProgress();
					if (ret.success) {
						//console.log(JSON.stringify(ret));
						$("#job").html(send_user);
						api.toast({
							msg : ret.message
						});
					} else if (ret) {
						api.toast({
							msg : ret.message
						});
					} else {
						api.toast({
							msg : err.body
						});
					}
				}, 'setSendUser&funid=report_problem&user_id=' + user[0].user_id + '&uuid=' + user[0].uuid + '&send_userid=' + sendid + '&send_user=' + send_user + '&problem_id=' + retdata[0].problem_id);
			}
		</script>
	</body>
</html>