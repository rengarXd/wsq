<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>body</title>
		<link rel="stylesheet" type="text/css" href="../../../css/Hui.css" />
		<link rel="stylesheet" href="../../../css/style.css" />
		<link rel="stylesheet" href="../../../css/fonts/iconfont.css" />
		<style>
			html, body {
				background-color: #fbfbfb;
			}
			.xy_border {
				border-bottom: 1px solid #f0f0f0;
			}
		</style>
	</head>
	<body>
		<div tapmode onclick="shijian();" class="H-text-list H-flexbox-horizontal H-font-size-14  H-border-vertical-bottom-after H-vertical-middle H-touch-active">
			<div class="H-flex-item H-theme-font-color-999 H-padding-horizontal-both-10 H-padding-vertical-both-12">
				事件类型<span class="H-margin-horizontal-left-25 H-theme-font-color-black" id="shijian">aaa</span>
			</div>
			<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
		</div>
		<div tapmode onclick="keshi();" class="H-text-list H-flexbox-horizontal H-font-size-14  H-border-vertical-bottom-after H-vertical-middle H-touch-active">
			<div class="H-flex-item H-theme-font-color-999 H-padding-horizontal-both-10 H-padding-vertical-both-12">
				上报科室<span class="H-margin-horizontal-left-25 H-theme-font-color-black" id="keshi">aaa</span>
			</div>
			<span class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="H-iconfont H-icon-arrow-right H-theme-font-color-ccc H-font-size-14 H-vertical-middle"></i></span>
		</div>
		<div tapmode="H-touch-active" onclick="map();" class="H-text-list H-flexbox-horizontal H-font-size-14  H-border-vertical-bottom-after H-vertical-middle H-touch-active">
			<div class=" H-theme-font-color-999 H-padding-horizontal-both-10 H-padding-vertical-both-12">
				选择位置
			</div>
			<span class="H-padding-horizontal-left-15 H-text-show-row-1" id="maplon"></span><span class=" H-text-show-row-1" id="maplat"></span>
			<span  class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="iconfont icon-dingwei H-theme-font-color-999 H-font-size-20 H-vertical-middle"></i></span>
		</div>
		<div class="H-text-list H-flexbox-horizontal H-font-size-14  H-border-vertical-bottom-after H-vertical-middle">
			<div class="H-theme-font-color-999 H-padding-horizontal-both-10 H-padding-vertical-both-12">
				同步事件
			</div>
			<!--<span tapmode="H-touch-active" onclick="map();" class="H-icon H-padding-horizontal-right-5 H-display-block"><i class="iconfont icon-dingwei H-theme-font-color-999 H-font-size-20 H-vertical-middle"></i></span>-->
			<div  class="H-flex-item H-padding-horizontal-left-15">
				<input type="radio" name="v" value="1" checked="" class="H-radio H-vertical-align-middle H-font-size-18 H-theme-font-color1 H-border-radius-circle">
				<span class="H-margin-horizontal-left-8 H-margin-horizontal-right-20">是</span>
				<input type="radio" name="v" value="0" class="H-radio H-vertical-align-middle H-font-size-18 H-theme-font-color1 H-border-radius-circle">
				<span class="H-margin-horizontal-left-8">否</span>
			</div>
		</div>
		<div class="H-margin-horizontal-both-10 H-font-size-14" style="border-color:#555555; ">
			<div class="H-padding-horizontal-right-20 H-padding-vertical-both-10 H-theme-font-color-999" id="" style="">
				事件描述
			</div>
			<textarea id="textarea" class=" H-textbox H-vertical-align-middle H-vertical-middle H-font-size-16 H-flex-item H-box-sizing-border-box  H-outline-none H-padding-12" style="width: 100%;border-radius: 5px; color:#999999;" placeholder="请尽量详细描述问题"></textarea>
		</div>
	</body>
	<script type="text/javascript" src="../../../script/wsq.js"></script>
	<script type="text/javascript" src="../../../script/zepto.min.js"></script>
	<script type="text/javascript">
		var userdata = null, maplon = null, maplat = null;
		apiready = function() {
			initPage();
		};
		// 初始化页面
		function initPage() {
			api.getPrefs({
				sync : false,
				key : 'userinfo'
			}, function(ret, err) {
				if (ret && ret.value) {
					userdata = eval('(' + ret.value + ')');
				}
			});
			api.addEventListener({
				name : 'maplocation'
			}, function(ret, err) {
				//alert(JSON.stringify(ret));
				if (ret && ret.value) {
					//$("#maplocal").html(ret.value.lon + ',' + ret.value.lat);
					$("#maplon").html(ret.value.lon + '，');
					$("#maplat").html(ret.value.lat);
					maplon = ret.value.lon;
					maplat = ret.value.lat;
				}
			});
		}

		function map() {
			$xy.openWin('map_head', 'map_head.html', false, api.pageParam);
		}

		function shijian() {
			api.showProgress();
			$xy.ajax(function(ret, err) {
				api.hideProgress();
				if (ret && ret.success) {
					var dept = new Array();
					for (var i = 0, len = ret.data.length; i < len; i++) {
						dept.push(ret.data[i].display_data);
					};
					var retdata = ret.data;
					api.actionSheet({
						title : '事件类型',
						cancelTitle : '取消',
						buttons : dept
					}, function(ret, err) {
						var index = ret.buttonIndex;
						$("#shijian").html(retdata[parseInt(index) - 1].display_data);
						$("#shijian").attr('shijian', retdata[parseInt(index) - 1].value_data);
					});
				} else {
					api.toast({
						msg : ret.message
					});
				}
			}, 'selEventype&funid=report_problem&control=eventype');
		}

		function keshi() {
			api.showProgress();
			$xy.ajax(function(ret, err) {
				api.hideProgress();
				if (ret && ret.success) {
					var dept = new Array();
					for (var i = 0, len = ret.data.length; i < len; i++) {
						dept.push(ret.data[i].dept_name);
					};
					var retdata = ret.data;
					api.actionSheet({
						title : '上报科室',
						cancelTitle : '取消',
						buttons : dept
					}, function(ret, err) {
						var index = ret.buttonIndex;
						$("#keshi").html(retdata[parseInt(index) - 1].dept_name);
						$("#keshi").attr('keshi', retdata[parseInt(index) - 1].dept_id);
					});
				} else {
					api.toast({
						msg : ret.message
					});
				}
			}, 'selDept&funid=sys_dept');
		}

		//上传
		function uploadb() {
			//事件类型代码
			var problem_type = $("#shijian").attr('shijian');
			var dept_id = $("#keshi").attr('keshi');
			var is_synchro = $("input[type='radio']:checked").val();
			var problem_lng = maplon;
			var problem_lat = maplat;
			var problem_text = $("#textarea").val();
			if (problem_type && dept_id && is_synchro && problem_lng && problem_lat && problem_text) {
				api.showProgress({
					title : '上传中'
				});
				$xy.ajax(function(ret, err) {
					api.hideProgress();
					//alert(JSON.stringify(ret));
					api.toast({
						msg : ret.body.message
					});
					if (ret && ret.body.success) {
						setTimeout(function() {
							api.closeWin();
						}, 800);
					}
				}, 'addProblem&funid=report_problem', 'post', {
					values : {
						user_id : userdata[0].user_id,
						uuid : userdata[0].uuid,
						problem_type : problem_type,
						dept_id : dept_id,
						is_synchro : is_synchro,
						problem_lng : problem_lng,
						problem_lat : problem_lat,
						problem_text : problem_text
					}
				});
			} else {
				alert('您还有未填项');
			}
		}
	</script>
</html>