<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<title>title</title>
		<link rel="stylesheet" type="text/css" href="../../css/Hui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../../css/fonts/iconfont.css" />
		<style>
			html, body {
				background-image: url('../../image/wsqlogin.png');
				background-size: cover;
			}
			.active {
				color: #49b1f4;
				/*				border-bottom: 2px #1786FF solid;*/
				border: 1px solid #49b1f4;
			}
			.xy_border {
				border-bottom: 1px solid #f0f0f0;
			}
			.xy_border_top {
				border-bottom: 1px solid #f0f0f0;
				margin-left: 20px;
				margin-right: 20px;
			}
			.border-dx {
				border-radius: 20px;
			}
			.chacha {
				padding-top: 40px;
				padding-right: 30px;
			}
		</style>
	</head>
	<body>
		<!--无网络登录和获取验证码优化-->
		<!--<div id="top_position" >
		<div class="chacha H-text-align-right H-theme-font-color-white">
		<i tapmode="H-touch-active" onclick="api.closeWin();" class="iconfont H-touch-active icon-chacha H-font-size-20"></i>
		</div>
		</div>-->
		<div class="top_part" style="height: 300px;"></div>
		<div class="H-padding-15">
			<div class="H-border-radius-5 H-flexbox-horizontal H-border-vertical-both-after H-theme-background-color-white">
				<input style="color:#49b1f4;" id="code" type="text" class="H-textbox H-vertical-align-middle H-width-100-percent H-vertical-middle H-font-size-16 H-flex-item H-box-sizing-border-box H-border-none H-outline-none H-padding-12 H-padding-horizontal-left-25" placeholder="请输入用户名...">
			</div>
			<div class="H-margin-vertical-top-8"></div>
			<div class="H-border-radius-5 H-flexbox-horizontal H-border-vertical-bottom-after H-theme-background-color-white">
				<input id="pwd_1" style="color:#49b1f4;" type="password" class="H-textbox H-vertical-align-middle H-vertical-middle H-width-100-percent H-font-size-16 H-flex-item H-box-sizing-border-box H-border-none H-outline-none H-padding-12 H-padding-horizontal-left-25" placeholder="请输入密码...">
			</div>
			<div class="H-padding-horizontal-both-5 H-padding-vertical-top-10">
				<input type="checkbox" class="H-checkbox H-checkbox-null H-vertical-align-middle H-font-size-15 H-theme-font-color-black H-border-radius-5">
				<span class="H-theme-font-color-white H-font-size-16">记住密码</span>
				<span class="H-float-right H-line-height-normal"><i class="H-font-size-20 H-theme-font-color-white iconfont icon-zhuce-copy-copy"></i><span onclick="register();" class="H-padding-horizontal-left-5 H-font-size-16 H-theme-font-color-white">用户注册</span></span>
			</div>
			<div class="H-padding-horizontal-both-20 H-padding-vertical-top-10">
				<button onclick="checkCode();" class="H-touch-active xy_confirm_btn H-margin-vertical-top-10 H-position-static H-button H-width-100-percent  H-font-size-15 H-border-none H-padding-vertical-both-12 H-padding-horizontal-both-20  H-theme-font-color-white ">
					登&nbsp;&nbsp;&nbsp;录
				</button>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../script/zepto.min.js"></script>
	<script type="text/javascript" src="../../script/wsq.js"></script>
	<script type="text/javascript">
		var jpush = null, tel = null, jpush = null, systemtype = null, is_send_smsVerify = false;
		apiready = function() {
			api.parseTapmode();
			init();
			listener();
		};
		//初始化信息
		function init() {
			//jpush = api.require('ajpush');
			systemtype = api.systemType;
			$("#top_position").css('height', api.frameHeight * 2 / 5);
			$("#top_part").css('height', api.frameHeight / 2);
			$xy.dblclickToCloseApp();
		}

		Zepto(function($) {
			//			$("#tab div").on("tap", function() {
			//				$("#tab div").eq($(this).index()).addClass('active').siblings().removeClass('active');
			//				$("#content .switvh").hide().eq($(this).index()).show();
			//			});
		});
		//监听网络状态
		function listener() {
			api.addEventListener({
				name : 'offline'
			}, function(ret, err) {
				api.toast({
					msg : '未连接网络'
				});
			});
			api.addEventListener({
				name : 'online'
			}, function(ret, err) {
				api.toast({
					msg : '已连接网络'
				});
			});
		}

		function checkCode() {
			$xy.openWin('index_head_1', '../main/index_head_1.html', false, api.pageParam);
		}

		function register() {
			$xy.openWin('register', 'register.html', false, api.pageParam);
		}

		//点击获取验证码
		function getVerify() {
			var tel = $("#tel").val();
			// 手机号的正则
			var a = /^13[0-9]{9}$|14[0-9]{9}|15[0-9]{9}$|18[0-9]{9}$|17[0-9]{9}$/;
			// 判断手机号
			if (!tel.match(a)) {
				// 如果不是正确的手机号
				api.alert({
					title : '温馨提示',
					msg : '请输入正确的手机号！',
				}, function(ret, err) {
					if (ret && ret.buttonIndex == 1) {
						$("#tel").focus();
					}
				});
			} else {
				if (is_send_smsVerify) {
					api.toast({
						msg : '您已经发送过验证码了'
					});
				} else {
					api.showProgress({
						title : '获取中',
						text : '请稍等....'
					});
					$xy.ajax(function(ret, err) {
						api.hideProgress();
						if (ret) {
							//$("#nonetwork").hide();
							if (ret.success) {
								//$("#sendVerify").removeAttr('onclick');
								is_send_smsVerify = true;
								$('#sendVerify').html('<span id="Verifytime">60</span>');
								time = 60;
								isinerval = setInterval("CountDown()", 1000);
							} else {
								api.toast({
									msg : '很抱歉，短信获取失败，请稍后再试！',
									location : 'middle'
								});
							}
						} else {
							api.toast({
								msg : '连接失败，请检查网络配置',
								location : 'middle'
							});
							//$("#nonetwork").show();
						}
					}, 'sendtplValue&funid=wash_user&phone_number=' + tel);
				}
			}
		}

		//时间递减处理
		function CountDown() {
			if (time < 1) {
				//              var sendVerify = document.getElementById('sendVerify');
				clearInterval(isinerval);
				//$('#sendVerify').attr('onclick', 'getVerify()');
				$('#sendVerify').html('重新获取');
				//还原标识
				is_send_smsVerify = false;
				return;
			}
			//          var getVerify = document.getElementById('getVerify');
			$('#Verifytime').html('' + time + '');
			time--;
		}

		//登录按钮
		function login_btn() {
			var tel = $("#tel").val();
			// 手机号的正则
			var a = /^13[0-9]{9}$|14[0-9]{9}|15[0-9]{9}$|18[0-9]{9}$|17[0-9]{9}$/;
			//获取验证码
			var code = $("#code").val();
			//验证码正则
			var b = /^[0-9]{4}$/;
			// 判断手机号
			if (!tel.match(a)) {
				// 如果不是正确的手机号
				api.alert({
					title : '温馨提示',
					msg : '请输入正确的手机号！',
				}, function(ret, err) {
					if (ret && ret.buttonIndex == 1) {
						$("#tel").focus();
					}
				});
				return;
			}
			if (!code.match(b)) {
				// 如果不是正确的手机号
				api.alert({
					title : '温馨提示',
					msg : '抱歉验证码格式错误',
				}, function(ret, err) {
					if (ret && ret.buttonIndex == 1) {
						$("#code").focus();
					}
				});
				return;
			}
			api.showProgress({
				title : "登录中"
			});
			$xy.ajax(function(ret, err) {
				if (ret) {
					//$("#nonetwork").hide();
					if (ret.success) {
						//存储用户数据
						retInfo = ret.data;
						if (ret.data[0].uuid) {
							//存储用户数据
							$xy.userlogInfo(retInfo);
							//执行main页面获取用户信息的函数
							api.execScript({
								name : 'main',
								script : 'initInfo();'
							});
							api.hideProgress();
							//初始化推送
							if (systemtype != "ios") {
								//初始化android推送
								jpush.init(function(ret) {
									if (ret && ret.status) {
										//注册设备
										registID(retInfo);
									}
								});
							} else {
								//适配ios推送
								//注册设备
								registID(retInfo);
							}
							//登录成功对话框
							alertLog('登录成功', '想要继续完善您的信息吗？', '不用了', '继续', function(ret) {
								if (ret.eventType == 'left') {
									var dialogBox = api.require('dialogBox');
									dialogBox.close({
										dialogName : 'alert'
									});
									api.closeWin();
								} else {
									var dialogBox = api.require('dialogBox');
									dialogBox.close({
										dialogName : 'alert'
									});
									api.openWin({
										name : 'user_set_head',
										url : '../me/user_set_head.html',
										bounces : false,
										delay : 0,
									});
									setTimeout(function() {
										api.closeWin();
									}, 500);
								}
							});
						} else {
							api.hideProgress();
							//登录成功对话框
							alertLog('登录失败', '由于您长时间未登录须进行身份验证', '取消', '继续', function(ret) {
								if (ret.eventType == 'left') {
									var dialogBox = api.require('dialogBox');
									dialogBox.close({
										dialogName : 'alert'
									});
								} else {
									var dialogBox = api.require('dialogBox');
									dialogBox.close({
										dialogName : 'alert'
									});
									//alert(JSON.stringify(retInfo));
									api.openWin({
										name : 'check_login_head',
										url : 'check_login_head.html',
										pageParam : {
											data : retInfo,
											tel : tel
										},
										bounces : false,
										delay : 0,
									});
								}
							});
						}
					} else {
						api.hideProgress();
						api.toast({
							msg : ret.message
						});
					}
				} else {
					api.hideProgress();
					api.toast({
						msg : '连接失败，请检查网络配置',
						location : 'middle'
					});
					//$("#nonetwork").show();
				}
			}, 'appRegister&funid=wash_user&phone_number=' + tel + '&verify=' + code);
		}

		function registID(retInfo) {
			jpush.getRegistrationId(function(ret) {
				//console.log(JSON.stringify(ret));
				var registrationId = ret.id;
				$xy.ajax(function(ret, err) {
					//console.log("绑定成功！");
					console.log(JSON.stringify(ret));
					//												if (ret) {
					//												} else {
					//												}
				}, 'updateRegistration&funid=wash_user&registrationId=' + registrationId + '&wash_user_id=' + retInfo[0].wash_user_id + '&uuid=' + retInfo[0].uuid);
			});
		}

		//服务密码登录
		//		function password_login() {
		//			var tel = $("#pw_tel").val();
		//			// 手机号的正则
		//			var a = /^13[0-9]{9}$|14[0-9]{9}|15[0-9]{9}$|18[0-9]{9}$|17[0-9]{9}$/;
		//			//获取密码
		//			var password = $("#pw_password").val();
		//			//密码正则
		//			var b = /^[\w\W]{6,18}$/;
		//			// 判断手机号
		//			if (!tel.match(a)) {
		//				// 如果不是正确的手机号
		//				api.alert({
		//					title : '温馨提示',
		//					msg : '请输入正确的手机号！',
		//				}, function(ret, err) {
		//					if (ret && ret.buttonIndex == 1) {
		//						$("#pw_tel").focus();
		//					}
		//				});
		//				return;
		//			}
		//			if (!password.match(b)) {
		//				// 如果不是正确的密码
		//				api.alert({
		//					title : '温馨提示',
		//					msg : '请输入6-18位任意字符的密码',
		//				}, function(ret, err) {
		//					if (ret && ret.buttonIndex == 1) {
		//						$("#pw_password").focus();
		//					}
		//				});
		//				return;
		//			}
		//			if (!$("#checkbox-2").attr("checked")) {
		//				api.toast({
		//					msg : '请您选择同意《用户协议》'
		//				});
		//				return;
		//			}
		//			api.showProgress({
		//				title : "登录中"
		//			});
		//			//console.log(JSON.stringify(tel));
		//			//console.log(JSON.stringify(password));
		//			$xy.ajax(function(ret, err) {
		//				api.hideProgress();
		//				if (ret) {
		//					//console.log(JSON.stringify(ret));
		//					//$("#nonetwork").hide();
		//					if (ret.success) {
		//						//console.log(JSON.stringify(1));
		//						retInfo = ret.data;
		//						if (ret.data[0].user_id) {
		//							//存储用户数据
		//							$xy.userlogInfo(retInfo);
		//							//登录成功对话框
		//							alertLog('登录成功', '想要继续完善您的信息吗？', '不用了', '继续', function(ret) {
		//								if (ret.eventType == 'left') {
		//									var dialogBox = api.require('dialogBox');
		//									dialogBox.close({
		//										dialogName : 'alert'
		//									});
		//									api.closeWin();
		//								} else {
		//									var dialogBox = api.require('dialogBox');
		//									dialogBox.close({
		//										dialogName : 'alert'
		//									});
		//									api.openWin({
		//										name : 'user_set_head',
		//										url : '../me/user_set_head.html',
		//										bounces : false,
		//										delay : 0,
		//									});
		//									setTimeout(function() {
		//										api.closeWin();
		//									}, 1000);
		//								}
		//							});
		//						} else {
		//							//登录成功对话框
		//							alertLog('登录失败', '由于您长时间未登录将进行身份验证，选择‘不用了’则将原账号情况并重新创建一个新账号，选择‘继续’则进行身份验证', '不用了', '继续', function(ret) {
		//								if (ret.eventType == 'left') {
		//									var dialogBox = api.require('dialogBox');
		//									dialogBox.close({
		//										dialogName : 'alert'
		//									});
		//									api.closeWin();
		//								} else {
		//									var dialogBox = api.require('dialogBox');
		//									dialogBox.close({
		//										dialogName : 'alert'
		//									});
		//									api.openWin({
		//										name : 'check_login_head',
		//										url : 'check_login_head.html',
		//										pageParam : {
		//											data : retInfo
		//										},
		//										bounces : false,
		//										delay : 0,
		//									});
		//									setTimeout(function() {
		//										api.closeWin();
		//									}, 1000);
		//								}
		//							});
		//						}
		//					} else {
		//						//console.log(JSON.stringify(2));
		//						api.toast({
		//							msg : ret.message
		//						});
		//					}
		//				} else {
		//					$("#nonetwork").show();
		//				}
		//			}, 'serverRegister&funid=wash_user&phone_number=' + tel + '&service_password=' + password);
		//		}
		//打开服务条款
		function openTermsService() {
			var delay = 0;
			if (api.systemType != 'ios')
				delay = 100;
			api.openWin({
				name : 'terms_service_head',
				url : './terms_service/terms_service_head.html',
				bounces : false,
				delay : delay,
			});
		}

		//dialog对话框
		function alertLog(title, content, leftBtnTitle, rightBtnTitle, callback) {
			var dialogBox = api.require('dialogBox');
			dialogBox.alert({
				texts : {
					title : title,
					content : content,
					leftBtnTitle : leftBtnTitle,
					rightBtnTitle : rightBtnTitle
				},
				styles : {
					bg : '#fff',
					w : 300,
					corner : 5,
					title : {
						marginT : 30,
						titleSize : 18,
						titleColor : '#119ed1'
					},
					content : {
						color : '#555555',
						marginT : 30,
						marginB : 50,
						size : 16
					},
					left : {
						marginB : 0,
						marginL : 0,
						w : 150,
						h : 50,
						bg : '#fff',
						color : '#cacaca',
						size : 15
					},
					right : {
						marginB : 0,
						marginL : 0,
						w : 150,
						h : 50,
						bg : '#119ed1',
						color : '#fff',
						size : 15
					}
				}
			}, function(ret) {
				callback(ret);
			});
		}
	</script>
</html>